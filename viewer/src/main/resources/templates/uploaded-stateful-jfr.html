<!--
/*
 * Copyright 2022 Krzysztof Slusarski
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
-->
<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="/css/upload-materialized.css" rel="stylesheet">
</head>

<body th:data-current="${currentId}">

<div>
    <div class="row">
        <div class="col s2">
            <div class="card">
                <div class="card-content">
                    <div class="card-title">
                        What do you need?
                    </div>
                    <p class="row">
                        <a target="_blank" href="#" onclick="return enableFlameGraphs()">Flame graphs</a>
                    </p>
                    <p class="row">
                        <a target="_blank" href="#" onclick="return enableCorrelationId()">Correlation ID stats</a>
                    </p>
                    <p class="row">
                        <a target="_blank" href="#" onclick="return enableCpu()">CPU stats</a>
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-content">
                    <div class="card-title">
                        Available events
                    </div>
                    <p class="row" th:if="${file.executionSamples.size() > 0}">
                        <a target="_blank" href="#" onclick="return updatePages(this)"
                           th:data-current="${currentId}"
                           th:data-url="'/stateful-jfr/single/samples/execution?id=' + ${currentId}">Execution samples</a>
                    </p>
                    <p class="row" th:if="${file.allocationSamples.size() > 0}">
                        <a target="_blank" href="#" onclick="return updatePages(this)"
                           th:data-current="${currentId}"
                           th:data-url="'/stateful-jfr/single/samples/allocation/count?id=' + ${currentId}">Alloc. samples (count)</a>
                    </p>
                    <p class="row" th:if="${file.allocationSamples.size() > 0}">
                        <a target="_blank" href="#" onclick="return updatePages(this)"
                           th:data-current="${currentId}"
                           th:data-url="'/stateful-jfr/single/samples/allocation/size?id=' + ${currentId}">Alloc. samples (size)</a>
                    </p>
                    <p class="row" th:if="${file.lockSamples.size() > 0}">
                        <a target="_blank" href="#" onclick="return updatePages(this)"
                           th:data-current="${currentId}"
                           th:data-url="'/stateful-jfr/single/samples/lock?id=' + ${currentId}">Lock samples</a>
                    </p>
                </div>
            </div>

            <div class="card" id="additionalOptionsContainer">
                <div class="card-content">
                    <div class="card-title">
                        Additional options
                    </div>
                    <div>
                        <div class="row">
                            <div class="input-field col s12">
                                <label>
                                    <input id="reverseOn" name="reverseOn" type="checkbox"/>
                                    <span>Reverse flame graph</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" id="additionalFiltersContainer">
                <div class="card-content">
                    <div class="card-title">
                        Additional filters
                    </div>

                    <div class="row">
                        <div class="input-field col s12">
                            <label>
                                <input id="threadFilterOn" name="threadFilterOn" type="checkbox"/>
                                <span>Thread filter</span>
                            </label>
                        </div>
                        <div id="threadFilterContent" style="display: none">
                            <div class="input-field col s12">
                                <input id="threadFilter" name="threadFilter" type="text"/>
                                <label for="threadFilter">Thread filter</label>
                            </div>
                        </div>

                        <div class="input-field col s12">
                            <label>
                                <input id="ecidFilterOn" name="ecidFilterOn" type="checkbox"/>
                                <span>ECID filter</span>
                            </label>
                        </div>
                        <div id="ecidFilterContent" style="display: none">
                            <div class="input-field col s12">
                                <input id="ecidFilter" name="ecidFilter" type="text"/>
                                <label for=ecidFilter>ECID filter</label>
                            </div>
                        </div>

                        <div class="input-field col s12">
                            <label>
                                <input id="endDurationOn" name="endDurationOn" type="checkbox"/>
                                <span>Access log filter</span>
                            </label>
                        </div>
                        <div id="endDurationContent" style="display: none">
                            <div class="input-field col s12">
                                <input id="endDate" name="endDate" type="text"/>
                                <label for="endDate">End date</label>
                            </div>
                            <div class="input-field col s12">
                                <input id="endDateDateTimeFormat" name="endDateDateTimeFormat" type="text"
                                       value="dd/MMM/yyyy:HH:mm:ss Z"/>
                                <label for="endDateDateTimeFormat">End date format</label>
                            </div>
                            <div class="input-field col s12">
                                <input id="duration" name="duration" type="text"/>
                                <label for="duration">Duration (ms)</label>
                            </div>
                        </div>

                        <div class="input-field col s12">
                            <label>
                                <input id="startEndTimestampOn" name="startEndTimestampOn" type="checkbox"/>
                                <span>Start/end timestamp filter</span>
                            </label>
                        </div>
                        <div id="startEndTimestampContent" style="display: none">
                            <div class="input-field col s12">
                                <input id="startTs" name="startTs" type="text"/>
                                <label for="startTs">Start timestamp (s)</label>
                            </div>
                            <div class="input-field col s12">
                                <input id="endTs" name="endTs" type="text"/>
                                <label for="endTs">End timestamp (s)</label>
                            </div>
                        </div>

                        <div class="input-field col s12">
                            <label>
                                <input id="warmupCooldownOn" name="warmupCooldownOn" type="checkbox"/>
                                <span>Warmup/cooldown filter</span>
                            </label>
                        </div>
                        <div id="warmupCooldownContent" style="display: none">
                            <div class="input-field col s12">
                                <input id="warmup" name="warmup" type="text"/>
                                <label for="warmup">Warmup (s)</label>
                            </div>
                            <div class="input-field col s12">
                                <input id="cooldown" name="cooldown" type="text"/>
                                <label for="cooldown">Cooldown (s)</label>
                            </div>
                        </div>

                        <div class="input-field col s12">
                            <label>
                                <input id="warmupDurationOn" name="warmupDurationOn" type="checkbox"/>
                                <span>Warmup/duration filter</span>
                            </label>
                        </div>
                        <div id="warmupDurationContent" style="display: none">
                            <div class="input-field col s12">
                                <input id="wdWarmup" name="wdWarmup" type="text"/>
                                <label for="wdWarmup">Warmup (s)</label>
                            </div>
                            <div class="input-field col s12">
                                <input id="wdDuration" name="wdDuration" type="text"/>
                                <label for="wdDuration">Duration (s)</label>
                            </div>
                        </div>
                        <div class="input-field col s12">
                            <label>
                                <input id="consumeCpuOn" name="consumeCpuOn" type="checkbox"/>
                                <span>Consume CPU</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-content">
                    <div class="card-title">
                        Additional levels
                    </div>

                    <div>
                        <div class="row">
                            <div class="input-field col s12">
                                <label>
                                    <input class="additional-level" id="extractThreads" name="extractThreads"
                                           type="checkbox" checked/>
                                    <span>Add thread level</span>
                                </label>
                            </div>
                            <div class="input-field col s12">
                                <label>
                                    <input class="additional-level" id="extractTs10S" name="extractTs10S"
                                           type="checkbox"/>
                                    <span>Add timestamp level (10 second window)</span>
                                </label>
                            </div>
                            <div class="input-field col s12">
                                <label>
                                    <input class="additional-level" id="extractTs1S" name="extractTs1S"
                                           type="checkbox"/>
                                    <span>Add timestamp level (1 second window)</span>
                                </label>
                            </div>
                            <div class="input-field col s12">
                                <label>
                                    <input class="additional-level" id="extractTs100Ms" name="extractTs100Ms"
                                           type="checkbox"/>
                                    <span>Add timestamp level (100 ms window)</span>
                                </label>
                            </div>
                            <div class="input-field col s12">
                                <label>
                                    <input class="additional-level" id="extractFilename" name="extractFilename"
                                           type="checkbox"/>
                                    <span>Add filename level</span>
                                </label>
                            </div>
                            <div class="input-field col s12">
                                <label>
                                    <input class="additional-level" id="extractEcid" name="extractEcid"
                                           type="checkbox"/>
                                    <span>Add correlation id level</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-content">
                    Author: Krzysztof Ślusarski <br>
                    Email: ks@gclogs.com
                </div>
            </div>
        </div>

        <div class="col s10">
            <div class="card">
                <div class="card-content">
                    <iframe id="externalContent" width="100%" height="1000px" frameBorder="0" style="display:none;"></iframe>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" th:src="'/' + @{webjars/jquery/2.2.4/jquery.min.js}"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script type="text/javascript">
    $("#threadFilterOn").on("change", function () {
        if ($(this).prop('checked')) {
            $("#threadFilterContent").show();
        } else {
            $("#threadFilterContent").hide();
        }
    });
    $("#ecidFilterOn").on("change", function () {
        if ($(this).prop('checked')) {
            $("#ecidFilterContent").show();
        } else {
            $("#ecidFilterContent").hide();
        }
    });
    $("#startEndTimestampOn").on("change", function () {
        if ($(this).prop('checked')) {
            $("#startEndTimestampContent").show();
            $("#endDurationOn").prop("checked", false);
            $("#warmupCooldownOn").prop("checked", false);
            $("#warmupDurationOn").prop("checked", false);
            $("#warmupCooldownContent").hide();
            $("#warmupDurationContent").hide();
            $("#endDurationContent").hide();
        } else {
            $("#startEndTimestampContent").hide();
        }
    });
    $("#endDurationOn").on("change", function () {
        if ($(this).prop('checked')) {
            $("#endDurationContent").show();
            $("#startEndTimestampOn").prop("checked", false);
            $("#warmupCooldownOn").prop("checked", false);
            $("#warmupDurationOn").prop("checked", false);
            $("#startEndTimestampContent").hide();
            $("#warmupCooldownContent").hide();
            $("#warmupDurationContent").hide();
        } else {
            $("#endDurationContent").hide();
        }
    });
    $("#warmupCooldownOn").on("change", function () {
        if ($(this).prop('checked')) {
            $("#warmupCooldownContent").show();
            $("#startEndTimestampOn").prop("checked", false);
            $("#endDurationOn").prop("checked", false);
            $("#warmupDurationOn").prop("checked", false);
            $("#startEndTimestampContent").hide();
            $("#endDurationContent").hide();
            $("#warmupDurationContent").hide();
        } else {
            $("#warmupCooldownContent").hide();
        }
    });
    $("#warmupDurationOn").on("change", function () {
        if ($(this).prop('checked')) {
            $("#warmupDurationContent").show();
            $("#startEndTimestampOn").prop("checked", false);
            $("#endDurationOn").prop("checked", false);
            $("#warmupCooldownOn").prop("checked", false);
            $("#startEndTimestampContent").hide();
            $("#endDurationContent").hide();
            $("#warmupCooldownContent").hide();
        } else {
            $("#warmupDurationContent").hide();
        }
    });

    function enableFlameGraphs() {
        let externalContent = $("#externalContent");
        externalContent.show();
        externalContent.data("toShow", "flameGraphUrl");
        updateExternalContent();
        return false;
    }

    function enableCorrelationId() {
        let externalContent = $("#externalContent");
        externalContent.show();
        externalContent.data("toShow", "correlationIdStatsUrl");
        updateExternalContent();
        return false;
    }

    function enableCpu() {
        let externalContent = $("#externalContent");
        externalContent.show();
        externalContent.data("toShow", "cpuStatsUrl");
        updateNotEventDependentPages();
        updateExternalContent();
        return false;
    }

    function updateExternalContent() {
        let externalContent = $("#externalContent");
        let toShow = externalContent.data("toShow");
        console.log(toShow);
        if (toShow !== undefined) {
            let newSrc = externalContent.data(toShow);
            console.log(newSrc);
            if (newSrc !== undefined) {
                externalContent.attr("src", newSrc);
            }
        }
    }

    function updateNotEventDependentPages() {
        let cpuStatsUrl = "/stateful-jfr/single/cpu-stats?id=" + $("body").data("current");
        $("#additionalFiltersContainer").find("input:checked").each(function (index) {
            cpuStatsUrl = cpuStatsUrl + "&" + $(this).attr("name") + "=on"
        });
        $("#additionalFiltersContainer").find("input[type=text]").each(function (index) {
            cpuStatsUrl = cpuStatsUrl + "&" + $(this).attr("name") + "=" + $(this).val();
        });

        let externalContent = $("#externalContent");
        externalContent.data("cpuStatsUrl", cpuStatsUrl);
        updateExternalContent();
        return false;
    }

    function updatePages(pressed) {
        updateNotEventDependentPages();
        let flameGraphUrl = $(pressed).data("url");
        let correlationIdStatsUrl = "/stateful-jfr/single/correlation-id-stats?id=" + $(pressed).data("current");
        $(".additional-level:checked").each(function (index) {
            flameGraphUrl = flameGraphUrl + "&" + $(this).attr("name") + "=on"
        });
        $("#additionalOptionsContainer").find("input:checked").each(function (index) {
            flameGraphUrl = flameGraphUrl + "&" + $(this).attr("name") + "=on"
        });
        $("#additionalFiltersContainer").find("input:checked").each(function (index) {
            flameGraphUrl = flameGraphUrl + "&" + $(this).attr("name") + "=on"
            correlationIdStatsUrl = correlationIdStatsUrl + "&" + $(this).attr("name") + "=on"
        });
        $("#additionalFiltersContainer").find("input[type=text]").each(function (index) {
            flameGraphUrl = flameGraphUrl + "&" + $(this).attr("name") + "=" + $(this).val();
            correlationIdStatsUrl = correlationIdStatsUrl + "&" + $(this).attr("name") + "=" + $(this).val();
        });

        let externalContent = $("#externalContent");
        externalContent.data("flameGraphUrl", flameGraphUrl);
        externalContent.data("correlationIdStatsUrl", correlationIdStatsUrl);
        updateExternalContent();
        return false;
    }
</script>
</body>
</html>